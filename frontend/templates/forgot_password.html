<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password ‚Äî Krishi Sujhav</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { accent: '#0ea5a4' } } } }
  </script>
  <style>
    @keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    .fade-in { animation: fadeIn .4s ease-out; }
    .otp-input { width: 3rem; height: 3.5rem; text-align: center; font-size: 1.5rem; font-weight: 700; }
    .step-hidden { display: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 flex items-center justify-center p-4">
  <div class="max-w-md w-full space-y-6">

    <!-- Header -->
    <div class="text-center">
      <div class="mx-auto h-16 w-16 bg-accent rounded-full flex items-center justify-center mb-4 shadow-lg">
        <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
        </svg>
      </div>
      <h2 class="text-3xl font-bold text-slate-900">Reset Password</h2>
      <p class="mt-2 text-sm text-slate-600">Secure OTP-based password recovery</p>
    </div>

    <!-- Progress Bar -->
    <div class="flex items-center gap-2 px-4">
      <div id="prog1" class="flex-1 h-1.5 rounded-full bg-accent transition-colors duration-300"></div>
      <div id="prog2" class="flex-1 h-1.5 rounded-full bg-slate-200 transition-colors duration-300"></div>
      <div id="prog3" class="flex-1 h-1.5 rounded-full bg-slate-200 transition-colors duration-300"></div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-8">

      <!-- Global Alert Box -->
      <div id="alertBox" class="hidden mb-5 p-3 rounded-lg text-sm border"></div>

      <!-- ===================== STEP 1: Enter Email ===================== -->
      <div id="step1" class="fade-in">
        <div class="text-center mb-6">
          <div class="mx-auto h-12 w-12 bg-accent/10 rounded-full flex items-center justify-center mb-3">
            <svg class="h-6 w-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          </div>
          <h3 class="text-xl font-bold text-slate-900">Enter Your Email</h3>
          <p class="text-sm text-slate-500 mt-1">We'll send a 6-digit OTP to your registered Gmail</p>
        </div>

        <form id="emailForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Registered Email</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"/></svg>
              </div>
              <input id="resetEmail" type="email" required autocomplete="email"
                     class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent"
                     placeholder="farmer@gmail.com">
            </div>
          </div>
          <button type="submit" id="sendOtpBtn"
                  class="w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-accent hover:bg-accent/90 transition-colors shadow-sm">
            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send OTP
          </button>
        </form>
      </div>

      <!-- ===================== STEP 2: Verify OTP ===================== -->
      <div id="step2" class="step-hidden fade-in">
        <div class="text-center mb-6">
          <div class="mx-auto h-12 w-12 bg-blue-50 rounded-full flex items-center justify-center mb-3">
            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
          </div>
          <h3 class="text-xl font-bold text-slate-900">Verify OTP</h3>
          <p class="text-sm text-slate-500 mt-1">Enter the 6-digit code sent to <span id="maskedEmail" class="font-semibold text-accent"></span></p>
        </div>

        <form id="otpForm" class="space-y-5">
          <div class="flex justify-center gap-2">
            <input type="text" maxlength="1" class="otp-input border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-accent" data-otp="1" inputmode="numeric" pattern="[0-9]" required>
            <input type="text" maxlength="1" class="otp-input border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-accent" data-otp="2" inputmode="numeric" pattern="[0-9]" required>
            <input type="text" maxlength="1" class="otp-input border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-accent" data-otp="3" inputmode="numeric" pattern="[0-9]" required>
            <input type="text" maxlength="1" class="otp-input border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-accent" data-otp="4" inputmode="numeric" pattern="[0-9]" required>
            <input type="text" maxlength="1" class="otp-input border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-accent" data-otp="5" inputmode="numeric" pattern="[0-9]" required>
            <input type="text" maxlength="1" class="otp-input border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-accent" data-otp="6" inputmode="numeric" pattern="[0-9]" required>
          </div>

          <button type="submit" id="verifyOtpBtn"
                  class="w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition-colors shadow-sm">
            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Verify OTP
          </button>

          <div class="flex items-center justify-between text-sm">
            <span id="otpTimer" class="text-slate-500">Resend in <span id="countdown">60</span>s</span>
            <button type="button" id="resendOtpBtn" class="text-accent hover:text-accent/80 font-medium hidden" onclick="resendOtp()">Resend OTP</button>
          </div>
        </form>
      </div>

      <!-- ===================== STEP 3: Set New Password ===================== -->
      <div id="step3" class="step-hidden fade-in">
        <div class="text-center mb-6">
          <div class="mx-auto h-12 w-12 bg-green-50 rounded-full flex items-center justify-center mb-3">
            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
          </div>
          <h3 class="text-xl font-bold text-slate-900">Set New Password</h3>
          <p class="text-sm text-slate-500 mt-1">Choose a strong password for your account</p>
        </div>

        <form id="passwordForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">New Password</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              <input id="newPassword" type="password" required minlength="6"
                     class="block w-full pl-10 pr-10 py-3 border border-slate-300 rounded-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent"
                     placeholder="Minimum 6 characters">
              <button type="button" onclick="togglePasswordVisibility('newPassword', this)" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
              </button>
            </div>
            <!-- Password strength meter -->
            <div class="mt-2 h-1.5 bg-slate-100 rounded-full overflow-hidden">
              <div id="strengthBar" class="h-full rounded-full transition-all duration-300 w-0"></div>
            </div>
            <p id="strengthText" class="text-xs text-slate-400 mt-1"></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Confirm Password</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              </div>
              <input id="confirmPassword" type="password" required minlength="6"
                     class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent"
                     placeholder="Re-enter your password">
            </div>
            <p id="matchText" class="text-xs mt-1 hidden"></p>
          </div>

          <button type="submit" id="setPasswordBtn"
                  class="w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 transition-colors shadow-sm">
            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            Set New Password
          </button>
        </form>
      </div>

      <!-- ===================== STEP 4: Success ===================== -->
      <div id="step4" class="step-hidden fade-in">
        <div class="text-center py-6">
          <div class="mx-auto h-16 w-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
            <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <h3 class="text-2xl font-bold text-green-700">Password Reset Successful! üéâ</h3>
          <p class="text-sm text-slate-500 mt-2">Your password has been updated securely.</p>
          <p class="text-sm text-slate-500 mt-1">Redirecting to login page in <span id="redirectCountdown" class="font-bold text-accent">3</span> seconds...</p>
          <a href="/login" class="inline-block mt-5 px-6 py-2.5 bg-accent text-white rounded-lg font-medium hover:bg-accent/90 transition-colors shadow-sm">
            Go to Login ‚Üí
          </a>
        </div>
      </div>
    </div>

    <!-- Back to Login link -->
    <div class="text-center">
      <a href="/login" class="text-sm text-slate-600 hover:text-accent font-medium">‚Üê Back to Login</a>
    </div>

    <div class="text-center text-xs text-slate-500">
      <p>&copy; 2025 Krishi Sujhav ‚Äî Farmer Assistant. Secure password recovery.</p>
    </div>
  </div>

  <script>
    // ============ STATE ============
    let userEmail = '';
    let otpToken = '';
    let timerInterval = null;

    // ============ HELPERS ============
    function showAlert(msg, type) {
      const box = document.getElementById('alertBox');
      box.textContent = msg;
      const colors = {
        success: 'bg-green-50 border-green-400 text-green-700',
        error: 'bg-red-50 border-red-400 text-red-700',
        info: 'bg-blue-50 border-blue-400 text-blue-700'
      };
      box.className = `mb-5 p-3 rounded-lg text-sm border ${colors[type] || colors.info}`;
      box.classList.remove('hidden');
      if (type === 'success') setTimeout(() => box.classList.add('hidden'), 4000);
    }

    function hideAlert() { document.getElementById('alertBox').classList.add('hidden'); }

    function showStep(n) {
      for (let i = 1; i <= 4; i++) {
        document.getElementById('step' + i).classList.toggle('step-hidden', i !== n);
      }
      for (let i = 1; i <= 3; i++) {
        document.getElementById('prog' + i).classList.toggle('bg-accent', i <= n);
        document.getElementById('prog' + i).classList.toggle('bg-slate-200', i > n);
      }
      hideAlert();
    }

    function setLoading(btn, loading, text) {
      btn.disabled = loading;
      if (loading) {
        btn.dataset.origText = btn.innerHTML;
        btn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>${text}`;
      } else {
        btn.innerHTML = btn.dataset.origText;
      }
    }

    function maskEmail(email) {
      const [user, domain] = email.split('@');
      const masked = user.charAt(0) + '***' + user.charAt(user.length - 1);
      return masked + '@' + domain;
    }

    function togglePasswordVisibility(inputId, btn) {
      const input = document.getElementById(inputId);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    // ============ OTP INPUT AUTO-FOCUS ============
    document.querySelectorAll('.otp-input').forEach((input, idx, inputs) => {
      input.addEventListener('input', (e) => {
        const val = e.target.value.replace(/[^0-9]/g, '');
        e.target.value = val;
        if (val && idx < inputs.length - 1) inputs[idx + 1].focus();
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) inputs[idx - 1].focus();
      });
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pasteData = (e.clipboardData || window.clipboardData).getData('text').replace(/[^0-9]/g, '');
        for (let i = 0; i < Math.min(pasteData.length, inputs.length); i++) {
          inputs[i].value = pasteData[i];
        }
        const nextEmpty = Array.from(inputs).findIndex(inp => !inp.value);
        if (nextEmpty !== -1) inputs[nextEmpty].focus();
        else inputs[inputs.length - 1].focus();
      });
    });

    // ============ PASSWORD STRENGTH ============
    document.getElementById('newPassword')?.addEventListener('input', function() {
      const val = this.value;
      const bar = document.getElementById('strengthBar');
      const txt = document.getElementById('strengthText');
      let score = 0;
      if (val.length >= 6) score++;
      if (val.length >= 8) score++;
      if (/[A-Z]/.test(val)) score++;
      if (/[0-9]/.test(val)) score++;
      if (/[^A-Za-z0-9]/.test(val)) score++;

      const levels = [
        { w: '0%', c: '', t: '' },
        { w: '20%', c: 'bg-red-500', t: 'Weak' },
        { w: '40%', c: 'bg-orange-500', t: 'Fair' },
        { w: '60%', c: 'bg-yellow-500', t: 'Good' },
        { w: '80%', c: 'bg-lime-500', t: 'Strong' },
        { w: '100%', c: 'bg-green-500', t: 'Very Strong üí™' }
      ];
      bar.style.width = levels[score].w;
      bar.className = `h-full rounded-full transition-all duration-300 ${levels[score].c}`;
      txt.textContent = levels[score].t;
    });

    document.getElementById('confirmPassword')?.addEventListener('input', function() {
      const match = this.value === document.getElementById('newPassword').value;
      const txt = document.getElementById('matchText');
      txt.classList.remove('hidden');
      txt.textContent = match ? '‚úÖ Passwords match' : '‚ùå Passwords do not match';
      txt.className = `text-xs mt-1 ${match ? 'text-green-600' : 'text-red-600'}`;
    });

    // ============ STEP 1: SEND OTP ============
    document.getElementById('emailForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('resetEmail').value.trim().toLowerCase();
      if (!email) { showAlert('Please enter your email address', 'error'); return; }

      const btn = document.getElementById('sendOtpBtn');
      setLoading(btn, true, 'Sending OTP...');

      try {
        const resp = await fetch('/api/send-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await resp.json();

        if (resp.ok && data.success) {
          userEmail = email;
          otpToken = data.token || '';
          document.getElementById('maskedEmail').textContent = maskEmail(email);
          showStep(2);

          // Check if SMTP failed and OTP is returned directly (demo mode)
          if (data.demo_otp) {
            showAlert(`Email service unavailable. Your OTP is: ${data.demo_otp}`, 'info');
            // Auto-fill OTP inputs for convenience
            const otpDigits = data.demo_otp.split('');
            const otpInputs = document.querySelectorAll('.otp-input');
            otpDigits.forEach((d, i) => { if (otpInputs[i]) otpInputs[i].value = d; });
          } else {
            showAlert('OTP sent to your email! Check your inbox (and spam folder).', 'success');
          }
          startTimer();
          document.querySelector('.otp-input[data-otp="1"]').focus();
        } else {
          showAlert(data.error || 'Failed to send OTP. Please try again.', 'error');
        }
      } catch (err) {
        showAlert('Network error. Check your internet connection.', 'error');
      } finally {
        setLoading(btn, false);
      }
    });

    // ============ RESEND OTP TIMER ============
    function startTimer() {
      let seconds = 60;
      document.getElementById('countdown').textContent = seconds;
      document.getElementById('otpTimer').classList.remove('hidden');
      document.getElementById('resendOtpBtn').classList.add('hidden');
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        seconds--;
        document.getElementById('countdown').textContent = seconds;
        if (seconds <= 0) {
          clearInterval(timerInterval);
          document.getElementById('otpTimer').classList.add('hidden');
          document.getElementById('resendOtpBtn').classList.remove('hidden');
        }
      }, 1000);
    }

    async function resendOtp() {
      const btn = document.getElementById('resendOtpBtn');
      btn.disabled = true;
      btn.textContent = 'Sending...';
      try {
        const resp = await fetch('/api/send-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail })
        });
        const data = await resp.json();
        if (data.success) {
          otpToken = data.token || '';
          showAlert('New OTP sent! Check your email.', 'success');
          startTimer();
        } else {
          showAlert(data.error || 'Failed to resend OTP.', 'error');
        }
      } catch (err) {
        showAlert('Network error.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Resend OTP';
      }
    }

    // ============ STEP 2: VERIFY OTP ============
    document.getElementById('otpForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const inputs = document.querySelectorAll('.otp-input');
      const otp = Array.from(inputs).map(i => i.value).join('');
      if (otp.length !== 6) { showAlert('Please enter the complete 6-digit OTP', 'error'); return; }

      const btn = document.getElementById('verifyOtpBtn');
      setLoading(btn, true, 'Verifying...');

      try {
        const resp = await fetch('/api/verify-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail, otp, token: otpToken })
        });
        const data = await resp.json();

        if (resp.ok && data.success) {
          otpToken = data.reset_token || '';
          showStep(3);
          showAlert('OTP verified! Now set your new password.', 'success');
          document.getElementById('newPassword').focus();
        } else {
          showAlert(data.error || 'Invalid or expired OTP. Please try again.', 'error');
          inputs.forEach(i => { i.value = ''; });
          inputs[0].focus();
        }
      } catch (err) {
        showAlert('Network error.', 'error');
      } finally {
        setLoading(btn, false);
      }
    });

    // ============ STEP 3: SET NEW PASSWORD ============
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newPwd = document.getElementById('newPassword').value;
      const confirmPwd = document.getElementById('confirmPassword').value;

      if (newPwd.length < 6) { showAlert('Password must be at least 6 characters.', 'error'); return; }
      if (newPwd !== confirmPwd) { showAlert('Passwords do not match.', 'error'); return; }

      const btn = document.getElementById('setPasswordBtn');
      setLoading(btn, true, 'Setting password...');

      try {
        const resp = await fetch('/api/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail, new_password: newPwd, token: otpToken })
        });
        const data = await resp.json();

        if (resp.ok && data.success) {
          showStep(4);
          // Auto-redirect to login
          let sec = 3;
          const rInt = setInterval(() => {
            sec--;
            document.getElementById('redirectCountdown').textContent = sec;
            if (sec <= 0) { clearInterval(rInt); window.location.href = '/login'; }
          }, 1000);
        } else {
          showAlert(data.error || 'Failed to reset password.', 'error');
        }
      } catch (err) {
        showAlert('Network error.', 'error');
      } finally {
        setLoading(btn, false);
      }
    });
  </script>
  <!-- Unified language system -->
  <script src="{{ url_for('static', filename='js/language.js') }}"></script>
</body>
</html>
